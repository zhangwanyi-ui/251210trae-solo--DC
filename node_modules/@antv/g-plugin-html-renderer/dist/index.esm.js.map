{"version":3,"file":"index.esm.js","sources":["../src/HTMLRenderingPlugin.ts","../src/index.ts"],"sourcesContent":["import {\n  DisplayObject,\n  FederatedEvent,\n  CustomEvent,\n  GlobalRuntime,\n  HTML,\n  ICamera,\n  MutationEvent,\n  MutationRecord,\n  RenderingPlugin,\n  RenderingPluginContext,\n  CanvasEvent,\n  RenderReason,\n  isCSSRGB,\n  ElementEvent,\n  isPattern,\n  Shape,\n} from '@antv/g-lite';\nimport { isNil, isNumber, isString } from '@antv/util';\nimport type { mat4, vec3 } from 'gl-matrix';\n\nconst CANVAS_CAMERA_ID = 'g-canvas-camera';\n\nexport class HTMLRenderingPlugin implements RenderingPlugin {\n  static tag = 'HTMLRendering';\n\n  private context: RenderingPluginContext;\n\n  /**\n   * wrapper for camera\n   */\n  private $camera: HTMLDivElement;\n\n  private displayObjectHTMLElementMap = new WeakMap<\n    DisplayObject,\n    HTMLElement\n  >();\n\n  /**\n   * ! The reason for adding `offset` is that the `transform-origin` coordinate system of DOM is the local coordinate system of the element, while the `transform-origin` coordinate system of canvas drawing is the local coordinate system of the element's parent element. At the same time, the `transform` attribute value of the DOM element does not include `transform-origin`.\n   */\n  private joinTransformMatrix(matrix: mat4, offset: vec3 = [0, 0, 0]) {\n    return `matrix(${[\n      matrix[0],\n      matrix[1],\n      matrix[4],\n      matrix[5],\n      matrix[12] + offset[0],\n      matrix[13] + offset[1],\n    ].join(',')})`;\n  }\n\n  apply(context: RenderingPluginContext, runtime: GlobalRuntime) {\n    const { camera, renderingContext, renderingService } = context;\n    this.context = context;\n    const canvas = renderingContext.root.ownerDocument.defaultView;\n    const { nativeHTMLMap } = canvas.context.eventService;\n\n    const setTransform = (object: HTML, $el: HTMLElement) => {\n      $el.style.transform = this.joinTransformMatrix(\n        object.getWorldTransform(),\n        object.getOrigin(),\n      );\n    };\n\n    const handleMounted = (e: FederatedEvent) => {\n      const object = e.target as HTML;\n      if (object.nodeName === Shape.HTML) {\n        if (!this.$camera) {\n          this.$camera = this.createCamera(camera);\n        }\n\n        // create DOM element\n        const $el = this.getOrCreateEl(object);\n        this.$camera.appendChild($el);\n\n        Object.keys(object.attributes).forEach((name) => {\n          this.updateAttribute(name, object);\n        });\n\n        setTransform(object, $el);\n\n        nativeHTMLMap.set($el, object);\n      }\n    };\n\n    const handleUnmounted = (e: FederatedEvent) => {\n      const object = e.target as HTML;\n      if (object.nodeName === Shape.HTML && this.$camera) {\n        const $el = this.getOrCreateEl(object);\n        if ($el) {\n          $el.remove();\n          nativeHTMLMap.delete($el);\n        }\n      }\n    };\n\n    const handleAttributeChanged = (e: MutationEvent) => {\n      const object = e.target as HTML;\n      if (object.nodeName === Shape.HTML) {\n        const { attrName } = e;\n        this.updateAttribute(attrName, object);\n      }\n    };\n\n    const handleBoundsChanged = (\n      e: CustomEvent<{ detail: MutationRecord[] }>,\n    ) => {\n      const records = e.detail;\n      for (let i = 0; i < records.length; i++) {\n        const record = records[i];\n        const object = record.target as DisplayObject;\n        const nodes =\n          object.nodeName === Shape.FRAGMENT ? object.childNodes : [object];\n\n        nodes.forEach((node: DisplayObject) => {\n          if (node.nodeName === Shape.HTML) {\n            const $el = this.getOrCreateEl(node);\n            setTransform(node as HTML, $el);\n          }\n        });\n      }\n    };\n\n    const handleCanvasResize = () => {\n      if (this.$camera) {\n        const { width, height } = this.context.config;\n        this.$camera.parentElement.style.width = `${width || 0}px`;\n        this.$camera.parentElement.style.height = `${height || 0}px`;\n      }\n    };\n\n    renderingService.hooks.init.tap(HTMLRenderingPlugin.tag, () => {\n      canvas.addEventListener(CanvasEvent.RESIZE, handleCanvasResize);\n      canvas.addEventListener(ElementEvent.MOUNTED, handleMounted);\n      canvas.addEventListener(ElementEvent.UNMOUNTED, handleUnmounted);\n      canvas.addEventListener(\n        ElementEvent.ATTR_MODIFIED,\n        handleAttributeChanged,\n      );\n      canvas.addEventListener(ElementEvent.BOUNDS_CHANGED, handleBoundsChanged);\n    });\n\n    renderingService.hooks.endFrame.tap(HTMLRenderingPlugin.tag, () => {\n      if (\n        this.$camera &&\n        renderingContext.renderReasons.has(RenderReason.CAMERA_CHANGED)\n      ) {\n        this.$camera.style.transform = this.joinTransformMatrix(\n          camera.getOrthoMatrix(),\n        );\n      }\n    });\n\n    renderingService.hooks.destroy.tap(HTMLRenderingPlugin.tag, () => {\n      // remove camera\n      if (this.$camera) {\n        this.$camera.remove();\n      }\n\n      canvas.removeEventListener(CanvasEvent.RESIZE, handleCanvasResize);\n      canvas.removeEventListener(ElementEvent.MOUNTED, handleMounted);\n      canvas.removeEventListener(ElementEvent.UNMOUNTED, handleUnmounted);\n      canvas.removeEventListener(\n        ElementEvent.ATTR_MODIFIED,\n        handleAttributeChanged,\n      );\n      canvas.removeEventListener(\n        ElementEvent.BOUNDS_CHANGED,\n        handleBoundsChanged,\n      );\n    });\n  }\n\n  private createCamera(camera: ICamera) {\n    const { document: doc, width, height } = this.context.config;\n    const $canvas =\n      this.context.contextService.getDomElement() as unknown as HTMLElement;\n    const $container = $canvas.parentNode;\n    if ($container) {\n      const cameraId = CANVAS_CAMERA_ID;\n      let $existedCamera = $container.querySelector<HTMLDivElement>(\n        `#${cameraId}`,\n      );\n      if (!$existedCamera) {\n        // fix @see https://github.com/antvis/G/issues/1702\n        const $cameraContainer = (doc || document).createElement('div');\n        // HTML elements should not overflow with canvas @see https://github.com/antvis/G/issues/1163\n        $cameraContainer.style.overflow = 'hidden';\n        $cameraContainer.style.pointerEvents = 'none';\n        $cameraContainer.style.position = 'absolute';\n        $cameraContainer.style.left = `0px`;\n        $cameraContainer.style.top = `0px`;\n        $cameraContainer.style.width = `${width || 0}px`;\n        $cameraContainer.style.height = `${height || 0}px`;\n\n        const $camera = (doc || document).createElement('div');\n        $existedCamera = $camera;\n        $camera.id = cameraId;\n        // use absolute position\n        $camera.style.position = 'absolute';\n        // account for DOM element's offset @see https://github.com/antvis/G/issues/1150\n        $camera.style.left = `${$canvas.offsetLeft || 0}px`;\n        $camera.style.top = `${$canvas.offsetTop || 0}px`;\n        $camera.style.transformOrigin = 'left top';\n        $camera.style.transform = this.joinTransformMatrix(\n          camera.getOrthoMatrix(),\n        );\n        $camera.style.pointerEvents = 'none';\n        $camera.style.width = `100%`;\n        $camera.style.height = `100%`;\n\n        $cameraContainer.appendChild($camera);\n        $container.appendChild($cameraContainer);\n      }\n\n      return $existedCamera;\n    }\n    return null;\n  }\n\n  private getOrCreateEl(object: DisplayObject) {\n    const { document: doc } = this.context.config;\n    let $existedElement: HTMLElement | null =\n      this.displayObjectHTMLElementMap.get(object);\n\n    if (!$existedElement) {\n      $existedElement = (doc || document).createElement('div');\n      object.parsedStyle.$el = $existedElement;\n      this.displayObjectHTMLElementMap.set(object, $existedElement);\n      if (object.id) {\n        $existedElement.id = object.id;\n      }\n      if (object.name) {\n        $existedElement.setAttribute('name', object.name);\n      }\n      if (object.className) {\n        $existedElement.className = object.className;\n      }\n\n      // use absolute position\n      $existedElement.style.position = 'absolute';\n      // @see https://github.com/antvis/G/issues/1150\n      $existedElement.style['will-change'] = 'transform';\n      $existedElement.style.transform = this.joinTransformMatrix(\n        object.getWorldTransform(),\n        object.getOrigin(),\n      );\n    }\n\n    return $existedElement;\n  }\n\n  private updateAttribute(name: string, object: HTML) {\n    const $el = this.getOrCreateEl(object);\n    switch (name) {\n      case 'innerHTML':\n        const { innerHTML } = object.parsedStyle;\n        if (isString(innerHTML)) {\n          $el.innerHTML = innerHTML;\n        } else {\n          $el.innerHTML = '';\n          $el.appendChild(innerHTML);\n        }\n        break;\n      case 'x':\n        $el.style.left = `${object.parsedStyle.x}px`;\n        break;\n      case 'y':\n        $el.style.top = `${object.parsedStyle.y}px`;\n        break;\n      case 'transformOrigin':\n        const { transformOrigin } = object.parsedStyle;\n        $el.style['transform-origin'] = `${transformOrigin[0].buildCSSText(\n          null,\n          null,\n          '',\n        )} ${transformOrigin[1].buildCSSText(null, null, '')}`;\n        break;\n      case 'width':\n        const { width } = object.parsedStyle;\n        $el.style.width = isNumber(width)\n          ? `${width}px`\n          : (width as string).toString();\n        break;\n      case 'height':\n        const { height } = object.parsedStyle;\n        $el.style.height = isNumber(height)\n          ? `${height}px`\n          : (height as string).toString();\n        break;\n      case 'zIndex':\n        const { zIndex } = object.parsedStyle;\n        $el.style['z-index'] = `${zIndex}`;\n        break;\n      case 'visibility':\n        const { visibility } = object.parsedStyle;\n        $el.style.visibility = visibility;\n        break;\n      case 'pointerEvents':\n        const { pointerEvents = 'auto' } = object.parsedStyle;\n        $el.style.pointerEvents = pointerEvents;\n        break;\n      case 'opacity':\n        const { opacity } = object.parsedStyle;\n        $el.style.opacity = `${opacity}`;\n        break;\n      case 'fill':\n        const { fill } = object.parsedStyle;\n        let color = '';\n        if (isCSSRGB(fill)) {\n          if (fill.isNone) {\n            color = 'transparent';\n          } else {\n            color = object.getAttribute('fill') as string;\n          }\n        } else if (Array.isArray(fill)) {\n          color = object.getAttribute('fill') as string;\n        } else if (isPattern(fill)) {\n          // TODO: pattern, use background?\n        }\n        $el.style.background = color;\n        break;\n      case 'stroke':\n        const { stroke } = object.parsedStyle;\n        let borderColor = '';\n        if (isCSSRGB(stroke)) {\n          if (stroke.isNone) {\n            borderColor = 'transparent';\n          } else {\n            borderColor = object.getAttribute('stroke') as string;\n          }\n        } else if (Array.isArray(stroke)) {\n          borderColor = object.getAttribute('stroke') as string;\n        } else if (isPattern(stroke)) {\n          // TODO: pattern, use background?\n        }\n\n        $el.style['border-color'] = borderColor;\n        $el.style['border-style'] = 'solid';\n        break;\n      case 'lineWidth':\n        const { lineWidth } = object.parsedStyle;\n        $el.style['border-width'] = `${lineWidth || 0}px`;\n        break;\n      case 'lineDash':\n        $el.style['border-style'] = 'dashed';\n        break;\n      case 'filter':\n        const { filter } = object.style;\n        $el.style.filter = filter;\n        break;\n      default:\n        if (!isNil(object.style[name]) && object.style[name] !== '') {\n          $el.style[name] = object.style[name];\n        }\n    }\n  }\n}\n","import { AbstractRendererPlugin } from '@antv/g-lite';\nimport { HTMLRenderingPlugin } from './HTMLRenderingPlugin';\n\nexport class Plugin extends AbstractRendererPlugin {\n  name = 'html-renderer';\n  init(): void {\n    this.addRenderingPlugin(new HTMLRenderingPlugin());\n  }\n  destroy(): void {\n    this.removeAllRenderingPlugins();\n  }\n}\n"],"names":["CANVAS_CAMERA_ID","HTMLRenderingPlugin","_classCallCheck","displayObjectHTMLElementMap","WeakMap","_createClass","key","value","joinTransformMatrix","matrix","offset","arguments","length","undefined","concat","join","apply","context","runtime","_this","camera","renderingContext","renderingService","canvas","root","ownerDocument","defaultView","nativeHTMLMap","eventService","setTransform","object","$el","style","transform","getWorldTransform","getOrigin","handleMounted","e","target","nodeName","Shape","HTML","$camera","createCamera","getOrCreateEl","appendChild","Object","keys","attributes","forEach","name","updateAttribute","set","handleUnmounted","remove","handleAttributeChanged","attrName","handleBoundsChanged","records","detail","i","record","nodes","FRAGMENT","childNodes","node","handleCanvasResize","_this$context$config","config","width","height","parentElement","hooks","init","tap","tag","addEventListener","CanvasEvent","RESIZE","ElementEvent","MOUNTED","UNMOUNTED","ATTR_MODIFIED","BOUNDS_CHANGED","endFrame","renderReasons","has","RenderReason","CAMERA_CHANGED","getOrthoMatrix","destroy","removeEventListener","_this$context$config2","doc","document","$canvas","contextService","getDomElement","$container","parentNode","cameraId","$existedCamera","querySelector","$cameraContainer","createElement","overflow","pointerEvents","position","left","top","id","offsetLeft","offsetTop","transformOrigin","$existedElement","get","parsedStyle","setAttribute","className","innerHTML","isString","x","y","buildCSSText","isNumber","toString","zIndex","visibility","_object$parsedStyle$p","opacity","fill","color","isCSSRGB","isNone","getAttribute","Array","isArray","isPattern","background","stroke","borderColor","lineWidth","filter","isNil","Plugin","_AbstractRendererPlug","_len","args","_key","_callSuper","_inherits","addRenderingPlugin","removeAllRenderingPlugins","AbstractRendererPlugin"],"mappings":"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"}