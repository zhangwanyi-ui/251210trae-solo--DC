# DC在线业务系统 - 部署文档

## 1. 文档概述

### 1.1 文档目的

本文档详细描述了DC在线业务系统的部署流程，包括部署架构、环境准备、部署步骤、配置说明、监控和维护等内容，为运维人员提供明确的部署依据，确保系统能够顺利部署和稳定运行。

### 1.2 术语定义

| 术语 | 解释 |
|------|------|
| 部署 | 将系统从开发环境转移到生产环境的过程 |
| 环境变量 | 用于配置系统运行参数的变量 |
| 容器化 | 使用Docker等容器技术封装应用和依赖 |
| 持续集成 | 频繁地将代码集成到主干，并进行自动化测试 |
| 持续部署 | 自动化地将通过测试的代码部署到生产环境 |
| 负载均衡 | 分发网络流量到多个服务器，提高系统可用性和性能 |
| 高可用 | 系统在各种情况下都能保持正常运行的能力 |
| 监控 | 实时监控系统的运行状态和性能指标 |

## 2. 部署架构

### 2.1 系统架构

DC在线业务系统采用前后端分离的架构，包括前端应用、后端服务、数据库和缓存四个主要部分：

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    前端应用     │     │    后端服务     │     │    数据库       │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ React 18+       │     │ Node.js + Express │     │ MySQL 8.0+      │
│ Vite 5+         │     │ JWT认证        │     │ Sequelize ORM   │
│ Ant Design 5+   │     │ Redis缓存       │     │ 主从复制        │
└─────────────────┘     └─────────────────┘     └─────────────────┘
          │                       │                       ▲
          │                       ▼                       │
          │                 ┌─────────────────┐           │
          │                 │    Redis缓存    │           │
          │                 ├─────────────────┤           │
          │                 │ 缓存热点数据    │───────────┘
          │                 │ 会话管理        │
          │                 │ 消息队列        │
          │                 └─────────────────┘
          │
          ▼
┌─────────────────┐
│    客户端浏览器  │
└─────────────────┘
```

### 2.2 部署模式

系统支持以下部署模式：

| 部署模式 | 适用场景 | 特点 |
|----------|----------|------|
| 单机部署 | 开发、测试环境 | 所有服务部署在同一台服务器上，配置简单，成本低 |
| 集群部署 | 生产环境 | 服务部署在多台服务器上，通过负载均衡提高可用性和性能 |
| 容器化部署 | 开发、测试、生产环境 | 使用Docker容器封装应用和依赖，部署便捷，环境一致 |
| 云部署 | 生产环境 | 部署在云平台上，弹性扩展，按需付费，高可用 |

## 3. 环境准备

### 3.1 硬件要求

| 服务器类型 | CPU | 内存 | 硬盘 | 网络 |
|------------|-----|------|------|------|
| 前端服务器 | 2核+ | 4GB+ | 100GB SSD+ | 100Mbps+ |
| 后端服务器 | 4核+ | 8GB+ | 200GB SSD+ | 100Mbps+ |
| 数据库服务器 | 4核+ | 16GB+ | 500GB SSD+ | 100Mbps+ |
| Redis服务器 | 2核+ | 4GB+ | 100GB SSD+ | 100Mbps+ |

### 3.2 软件要求

| 软件 | 版本 | 用途 |
|------|------|------|
| Node.js | 18+ | 后端运行环境 |
| npm/yarn | 8+ | 包管理工具 |
| MySQL | 8.0+ | 关系型数据库 |
| Redis | 6.0+ | 缓存数据库 |
| Docker | 24+ | 容器化部署 |
| Docker Compose | 2.20+ | 容器编排工具 |
| Nginx | 1.20+ | 反向代理和静态资源服务器 |
| PM2 | 5.3+ | Node.js进程管理 |

## 4. 部署前准备

### 4.1 代码获取

从Git仓库获取最新代码：

```bash
git clone <repository-url>
cd <project-directory>
```

### 4.2 环境变量配置

创建环境变量文件，根据部署环境配置相应的参数：

```bash
# 前端环境变量
cp .env.example .env.production
# 编辑.env.production文件

# 后端环境变量
cp .env.example .env
# 编辑.env文件
```

### 4.3 依赖安装

```bash
# 前端依赖安装
cd frontend
npm install

# 后端依赖安装
cd ../backend
npm install
```

## 5. 前端部署

### 5.1 构建生产版本

```bash
cd frontend
npm run build
```

构建完成后，会在`dist`目录生成生产版本的静态文件。

### 5.2 部署到Nginx

1. **配置Nginx**：

```nginx
# /etc/nginx/conf.d/dc-online-business.conf
server {
    listen 80;
    server_name example.com;
    root /var/www/dc-online-business/dist;
    index index.html;

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # 前端路由配置
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

2. **部署静态文件**：

```bash
# 创建部署目录
mkdir -p /var/www/dc-online-business

# 复制静态文件
cp -r frontend/dist/* /var/www/dc-online-business/

# 重启Nginx
systemctl restart nginx
```

### 5.3 容器化部署

1. **创建Dockerfile**：

```dockerfile
# frontend/Dockerfile
FROM nginx:1.20-alpine

# 复制静态文件
COPY dist/ /usr/share/nginx/html/

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

# 暴露端口
EXPOSE 80

# 启动Nginx
CMD ["nginx", "-g", "daemon off;"]
```

2. **创建docker-compose.yml**：

```yaml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    environment:
      - NODE_ENV=production
    depends_on:
      - backend
    networks:
      - dc-network

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=root
      - DB_PASSWORD=password
      - DB_NAME=dc_online_business
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - mysql
      - redis
    networks:
      - dc-network

  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=dc_online_business
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - dc-network

  redis:
    image: redis:6.0
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - dc-network

volumes:
  mysql-data:
  redis-data:

networks:
  dc-network:
    driver: bridge
```

3. **启动容器**：

```bash
docker-compose up -d
```

## 6. 后端部署

### 6.1 直接部署

1. **启动服务**：

```bash
cd backend
# 使用PM2启动服务
pm install -g pm2
pm run build
pm run start:prod
```

2. **配置PM2**：

```json
// ecosystem.config.js
module.exports = {
  apps: [
    {
      name: 'dc-backend',
      script: './dist/server.js',
      instances: 'max',
      autorestart: true,
      watch: false,
      env: {
        NODE_ENV: 'production'
      }
    }
  ]
};
```

3. **使用PM2启动**：

```bash
pm run build
pm run start:pm2
```

### 6.2 容器化部署

1. **创建Dockerfile**：

```dockerfile
# backend/Dockerfile
FROM node:18-alpine

# 设置工作目录
WORKDIR /app

# 复制package.json和package-lock.json
COPY package*.json ./

# 安装依赖
RUN npm install --production

# 复制源代码
COPY src/ ./src/
COPY .env.example ./.env

# 构建生产版本
RUN npm run build

# 暴露端口
EXPOSE 3000

# 启动应用
CMD ["node", "dist/server.js"]
```

2. **启动容器**：

```bash
# 构建镜像
docker build -t dc-backend .

# 启动容器
docker run -d --name dc-backend -p 3000:3000 --env-file .env dc-backend
```

## 7. 数据库部署

### 7.1 直接部署

1. **安装MySQL**：

```bash
# Ubuntu/Debian
apt update
apt install mysql-server

# CentOS/RHEL
dnf install mysql-server

# 启动MySQL服务
systemctl start mysql
systemctl enable mysql
```

2. **创建数据库和用户**：

```bash
# 登录MySQL
mysql -u root -p

# 创建数据库
CREATE DATABASE dc_online_business CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 创建用户
CREATE USER 'dc_user'@'%' IDENTIFIED BY 'password';

# 授予权限
GRANT ALL PRIVILEGES ON dc_online_business.* TO 'dc_user'@'%';

# 刷新权限
FLUSH PRIVILEGES;
```

3. **初始化数据库**：

```bash
cd backend
# 使用Sequelize迁移
npx sequelize-cli db:migrate

# 导入初始数据
npx sequelize-cli db:seed:all
```

### 7.2 容器化部署

1. **使用Docker Compose**：

```yaml
# docker-compose.yml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=dc_online_business
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - dc-network

volumes:
  mysql-data:

networks:
  dc-network:
    driver: bridge
```

2. **创建初始化脚本**：

```sql
-- init.sql
CREATE DATABASE IF NOT EXISTS dc_online_business CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE USER IF NOT EXISTS 'dc_user'@'%' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON dc_online_business.* TO 'dc_user'@'%';
FLUSH PRIVILEGES;
```

3. **启动MySQL容器**：

```bash
docker-compose up -d mysql
```

## 8. 配置管理

### 8.1 环境变量

| 环境变量 | 描述 | 默认值 |
|----------|------|--------|
| NODE_ENV | 运行环境 | development |
| PORT | 服务端口 | 3000 |
| DB_HOST | 数据库主机 | localhost |
| DB_PORT | 数据库端口 | 3306 |
| DB_USER | 数据库用户名 | root |
| DB_PASSWORD | 数据库密码 | password |
| DB_NAME | 数据库名称 | dc_online_business |
| REDIS_HOST | Redis主机 | localhost |
| REDIS_PORT | Redis端口 | 6379 |
| JWT_SECRET | JWT密钥 | secret_key |
| JWT_EXPIRES_IN | JWT过期时间 | 24h |
| LOG_LEVEL | 日志级别 | info |
| API_BASE_URL | API基础URL | /api |

### 8.2 配置文件

```json
// config/config.json
{
  "development": {
    "database": "dc_online_business",
    "username": "root",
    "password": "password",
    "host": "localhost",
    "dialect": "mysql"
  },
  "test": {
    "database": "dc_online_business_test",
    "username": "root",
    "password": "password",
    "host": "localhost",
    "dialect": "mysql"
  },
  "production": {
    "database": "dc_online_business",
    "username": "root",
    "password": "password",
    "host": "localhost",
    "dialect": "mysql"
  }
}
```

## 9. 监控和维护

### 9.1 日志管理

1. **应用日志**：

```bash
# 查看PM2日志
pm run logs

# 查看Docker容器日志
docker logs -f dc-backend
```

2. **访问日志**：

```bash
# Nginx访问日志
cat /var/log/nginx/access.log

# Nginx错误日志
cat /var/log/nginx/error.log
```

### 9.2 性能监控

1. **Node.js监控**：

```bash
# 使用PM2监控
pm run monit

# 使用Node.js内置监控
node --inspect dist/server.js
```

2. **数据库监控**：

```bash
# MySQL监控
mysqladmin -u root -p status
mysqladmin -u root -p processlist

# Redis监控
redis-cli info
```

3. **使用监控工具**：

- **Prometheus + Grafana**：监控系统性能
- **ELK Stack**：日志收集和分析
- **New Relic**：应用性能监控
- **Datadog**：全栈监控

### 9.3 定期维护

1. **数据库备份**：

```bash
# 全量备份
mysqldump -u root -p dc_online_business > dc_online_business_backup.sql

# 增量备份
# 配置MySQL主从复制，使用binlog进行增量备份
```

2. **日志清理**：

```bash
# 清理Nginx日志
find /var/log/nginx -name "*.log" -type f -mtime +7 -delete

# 清理应用日志
find ./logs -name "*.log" -type f -mtime +7 -delete
```

3. **系统更新**：

```bash
# Ubuntu/Debian
apt update && apt upgrade -y

# CentOS/RHEL
dnf update -y
```

## 10. 故障排查

### 10.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 服务无法启动 | 端口被占用 | 查看端口占用情况，修改配置文件中的端口 |
| 数据库连接失败 | 数据库服务未启动或配置错误 | 检查数据库服务状态，验证数据库配置 |
| API返回500错误 | 代码错误或依赖问题 | 查看应用日志，定位错误原因 |
| 前端页面无法访问 | Nginx配置错误或服务未启动 | 检查Nginx配置，重启Nginx服务 |
| Redis连接失败 | Redis服务未启动或配置错误 | 检查Redis服务状态，验证Redis配置 |

### 10.2 日志分析

1. **错误日志分析**：

```bash
# 查看最新的错误日志
tail -n 100 logs/error.log

# 搜索特定错误
grep -r "ERROR" logs/
```

2. **性能分析**：

```bash
# 使用Node.js性能分析工具
node --prof dist/server.js
node --prof-process isolate-*.log > profile.txt
```

## 11. 版本升级

### 11.1 升级步骤

1. **备份数据**：

```bash
# 备份数据库
mysqldump -u root -p dc_online_business > dc_online_business_backup_$(date +%Y%m%d_%H%M%S).sql

# 备份代码
cp -r ./ ./dc_online_business_backup_$(date +%Y%m%d_%H%M%S)
```

2. **获取最新代码**：

```bash
git pull origin master
```

3. **更新依赖**：

```bash
# 前端依赖
cd frontend
npm install
npm run build

# 后端依赖
cd ../backend
npm install
npm run build
```

4. **更新数据库**：

```bash
# 使用Sequelize迁移
npx sequelize-cli db:migrate
```

5. **重启服务**：

```bash
# 重启后端服务
npm run restart:prod

# 重启前端服务
cp -r frontend/dist/* /var/www/dc-online-business/
systemctl restart nginx
```

### 11.2 回滚方案

1. **停止服务**：

```bash
# 停止后端服务
npm run stop:prod

# 停止前端服务
systemctl stop nginx
```

2. **恢复数据**：

```bash
# 恢复数据库
mysql -u root -p dc_online_business < dc_online_business_backup.sql

# 恢复代码
rm -rf ./
cp -r ./dc_online_business_backup_20230101_000000 ./
```

3. **重启服务**：

```bash
# 重启后端服务
npm run start:prod

# 重启前端服务
systemctl start nginx
```

## 12. 安全配置

### 12.1 数据库安全

1. **创建专用用户**：

```sql
CREATE USER 'dc_user'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON dc_online_business.* TO 'dc_user'@'%';
FLUSH PRIVILEGES;
```

2. **限制访问IP**：

```sql
-- 只允许特定IP访问
CREATE USER 'dc_user'@'192.168.1.1' IDENTIFIED BY 'strong_password';
GRANT ALL PRIVILEGES ON dc_online_business.* TO 'dc_user'@'192.168.1.1';
FLUSH PRIVILEGES;
```

3. **启用SSL**：

```ini
# my.cnf
[mysqld]
ssl-ca=/etc/mysql/ssl/ca.pem
ssl-cert=/etc/mysql/ssl/server-cert.pem
ssl-key=/etc/mysql/ssl/server-key.pem
```

### 12.2 应用安全

1. **使用HTTPS**：

```nginx
# /etc/nginx/conf.d/dc-online-business.conf
server {
    listen 443 ssl;
    server_name example.com;
    
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    
    # 其他配置...
}

# 重定向HTTP到HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$host$request_uri;
}
```

2. **设置安全响应头**：

```nginx
# /etc/nginx/conf.d/dc-online-business.conf
server {
    # 其他配置...
    
    # 安全响应头
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
    add_header Content-Security-Policy "default-src 'self'";
}
```

3. **防止SQL注入**：

- 使用参数化查询或ORM框架
- 输入验证和过滤
- 最小权限原则

4. **防止XSS攻击**：

- 输入验证和过滤
- 输出编码
- 使用CSP（Content-Security-Policy）

5. **防止CSRF攻击**：

- 使用CSRF令牌
- 验证Origin和Referer头
- 使用SameSite Cookie属性

## 13. 附录

### 13.1 常用命令

| 命令 | 描述 |
|------|------|
| `npm install` | 安装依赖 |
| `npm run build` | 构建生产版本 |
| `npm run start:dev` | 开发环境启动 |
| `npm run start:prod` | 生产环境启动 |
| `npm run start:pm2` | 使用PM2启动 |
| `npm run stop:prod` | 停止生产环境服务 |
| `npm run restart:prod` | 重启生产环境服务 |
| `npm run logs` | 查看应用日志 |
| `npm run monit` | 监控应用状态 |
| `docker-compose up -d` | 启动Docker容器 |
| `docker-compose down` | 停止Docker容器 |
| `docker logs -f <container-name>` | 查看Docker容器日志 |

### 13.2 联系方式

| 角色 | 姓名 | 联系方式 |
|------|------|----------|
| 系统管理员 | XXX | XXX@example.com |
| 开发负责人 | XXX | XXX@example.com |
| 运维负责人 | XXX | XXX@example.com |
| 数据库管理员 | XXX | XXX@example.com |